<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Rufina:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <title>Forest Reserve Tracker</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --forest-dark: #1a3a0fff;
        --forest-medium: #2d6a4f;
        --forest-light: #52b788;
        --forest-pale: #d8f3dc;
        --text-dark: #080826ff;
        --text-light: #efece8ff;
      }

      .bodi {
        font-family:
          "Nunito",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        color: var(--text-dark);
      }

      .navigation {
        position: sticky;
        height: 5vh;
        margin-bottom: -5vh;
        top: 0;
        z-index: 1000;
        background: var(--text-dark);
        width: 100%;
        box-shadow: 0 2px 6px var(--text-dark);
        overflow-x: auto;
        overflow-y: hidden;
        scrollbar-width: none;
        scrollbar-color: var(--forest-light) var(--text-dark);
      }

      .navigation::before,
      .navigation::after {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        width: 30px;
        pointer-events: none;
        z-index: 1001;
        display: none;
      }

      .navigation::before {
        left: 0;
        background: linear-gradient(
          to right,
          var(--text-dark) 0%,
          transparent 100%
        );
      }

      .navigation::after {
        right: 0;
        background: linear-gradient(
          to left,
          var(--text-dark) 0%,
          transparent 100%
        );
      }

      .navigation.show-left-arrow::before,
      .navigation.show-right-arrow::after {
        display: block;
      }

      .scroll-indicator {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        pointer-events: none;
        z-index: 1002;
        display: none;
      }

      .scroll-indicator svg {
        width: 100%;
        height: 100%;
        fill: var(--forest-light);
      }

      .scroll-indicator-left {
        left: 5px;
      }

      .scroll-indicator-right {
        right: 5px;
      }

      .navigation.show-left-arrow .scroll-indicator-left,
      .navigation.show-right-arrow .scroll-indicator-right {
        display: block;
      }

      .navigation::-webkit-scrollbar {
        height: 16px;
      }

      .navigation::-webkit-scrollbar-track {
        background: var(--text-dark);
      }

      .navigation::-webkit-scrollbar-thumb {
        background: var(--forest-light);
        border-radius: 3px;
      }

      .navigation::-webkit-scrollbar-thumb:hover {
        background: var(--forest-medium);
      }

      .nav-buttons {
        display: flex;
        height: 5vh;
        gap: 10px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        min-width: min-content;
        padding: 0 10px;
      }

      .nav-button {
        background: var(--forest-light);
        color: var(--text-dark);
        border: solid 2px;
        padding: 5px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 400;
        transition: all 0.3s ease;
        font-family: inherit;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .nav-button:hover {
        background: var(--forest-medium);
        color: var(--text-light);
        border-color: var(--forest-pale);
      }

      .nav-button.active {
        background: var(--forest-light);
        color: var(--text-dark);
      }

      .landing-section {
        width: 100%;
        height: 100vh;
        padding: 60px 20px 30px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: var(--forest-pale);
        text-align: center;
        overflow: hidden;
      }

      .section {
        min-height: 100vh;
        padding: 80px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .section h2 {
        font-family: "Rufina", serif;
        font-size: 2.5rem;
        margin-bottom: 30px;
        color: var(--text-dark);
      }

      .section-content {
        max-width: 1400px;
        width: 100%;
      }

      #map-section {
        background: #e8f5e9;
      }

      #data-table-section {
        background: #f1f8e9;
      }

      #about-section {
        background: #f9fbe7;
      }

      #methodology-section {
        background: #fffde7;
      }

      #investigations-section {
        background: #fff8e1;
      }

      .header {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 2vh;
        line-height: 1.2;
        flex-shrink: 0;
        max-width: 60vw;
      }

      .header h1 {
        font-family: "Rufina", serif;
        font-size: 3rem;
        /* margin-bottom: 15px; */
        font-weight: 700;
        margin-bottom: 1vh;
      }

      .header p {
        font-size: 1.1rem;
        line-height: 1.5;

        margin: 0 auto;
      }

      .table-container {
        background: var(--text-dark);
        border-radius: 6px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 3vh 1vw;
        width: 80%;
        gap: 2vh;

        margin: 1vh 0vw;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }

      .table-header {
        display: flex;
        flex-direction: column;
        gap: 1vh;
        flex-shrink: 0;
        align-items: center;
      }

      .table-title-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        color: var(--text-light);
        line-height: 1.6;
      }

      .table-title-text {
        font-weight: 400;
      }

      .filter-dropdown {
        background: var(--forest-light);
        color: var(--text-light);
        border: 2px solid var(--forest-light);
        padding: 0px 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23080826' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 32px;
      }

      .filter-dropdown:hover {
        background: var(--forest-medium);
        color: var(--text-light);
        border-color: var(--forest-pale);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'  viewBox='0 0 12 12'%3E%3Cpath fill='%23efece8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
      }

      /* .filter-dropdown:focus {
        /* outline: 2px solid var(--forest-light);
        outline-offset: 2px; 
        background-color: #52b788;
      } */

      .update-date-row {
        color: var(--text-light);
        font-size: 1rem;
      }

      .download-button {
        background: var(--forest-light);
        color: var(--text-dark);

        padding: 4px 8px;
        border: solid 2px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.3s ease;
        font-family: inherit;
        align-self: flex-start;
      }

      .download-button:hover {
        background: var(--forest-medium);
        color: var(--text-light);
        border-color: var(--forest-pale);
      }

      #table-content {
        overflow-x: auto;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
      }

      #table-content::-webkit-scrollbar {
        width: 6px;
      }

      #table-content::-webkit-scrollbar-track {
        background: var(--prussian-blue);
        border-radius: 4px;
      }

      #table-content::-webkit-scrollbar-thumb {
        background: var(--forest-pale);
        border-radius: 4px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.1rem;
      }

      table {
        width: 100%;
        scrollbar-color: var(--forest-light);
        scrollbar-width: 2px;
        border-collapse: collapse;
      }

      thead {
        background-color: var(--forest-medium);
        color: var(--text-light);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      th,
      td {
        padding: 12px 8px;
        text-align: center;
        border-bottom: 1px solid #dddddd2b;
        color: var(--text-light);
      }

      th {
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: capitalize;
        /* letter-spacing: 0.5px; */
      }

      .change-add {
        color: #3c8aff;
        font-weight: 600;
      }

      .change-remove {
        color: #e74c3c;
        font-weight: 600;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
        font-style: italic;
      }

      .table-footer {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #dddddd2b;
        text-align: center;
        color: var(--text-light);
        font-size: 0.9rem;
      }

      .table-footer a {
        color: var(--forest-light);
        text-decoration: none;
        font-weight: 600;
      }

      .table-footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .landing-section {
          padding: 60px 10px 30px 10px;
          /* padding: 60px 20px 30px 20px; */
        }

        .table-container {
          background: var(--text-dark);
          border-radius: 6px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
          padding: 30px;
          width: 100%;
          margin-top: 20px;
          display: flex;
          flex-direction: column;
          flex: 1;
          min-height: 0;
          overflow: hidden;
          margin-bottom: 20px;
        }

        .header {
          max-width: 100vw;
          margin-bottom: 2vh;
        }

        .header h1 {
          font-size: 2rem;
          margin-bottom: 1vh;
        }

        .header p {
          max-width: 80vw;
          font-size: 0.9rem;
          line-height: 1.2rem;
        }

        .navigation {
          -webkit-overflow-scrolling: touch;
        }

        .nav-buttons {
          justify-content: flex-start;
          flex-wrap: nowrap;
          padding: 0 10px;
        }

        .nav-button {
          font-size: 0.9rem;
          padding: 6px 10px;
        }

        .table-container {
          padding: 2vh 1vw;
          margin-top: 15px;
        }

        .table-title-row {
          font-size: 1rem;
          justify-content: center;
          text-align: center;
        }

        .filter-dropdown {
          font-size: 0.9rem;
          padding: 2px 8px;
          padding-right: 28px;
        }

        table {
          font-size: 0.75rem;
        }

        th,
        td {
          padding: 8px 4px;
          font-size: 0.75rem;
        }

        th:nth-child(1),
        td:nth-child(1) {
          min-width: 70px;
        }

        th:nth-child(2),
        td:nth-child(2) {
          min-width: 100px;
          max-width: 140px;
          word-wrap: break-word;
        }

        th:nth-child(3),
        td:nth-child(3) {
          min-width: 50px;
        }

        th:nth-child(4),
        td:nth-child(4) {
          min-width: 60px;
        }

        th:nth-child(5),
        td:nth-child(5) {
          min-width: 80px;
          max-width: 140px;
          word-wrap: break-word;
        }

        th:nth-child(6),
        td:nth-child(6) {
          min-width: 50px;
        }
      }
    </style>
  </head>
  <body>
    <div class="bodi">
      <!-- Navigation Bar -->
      <div class="navigation" id="nav-bar">
        <div class="scroll-indicator scroll-indicator-left">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
          </svg>
        </div>
        <div class="scroll-indicator scroll-indicator-right">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
          </svg>
        </div>
        <div class="nav-buttons">
          <button
            class="nav-button"
            onclick="scrollToSection('recent-changes')"
          >
            Recent Changes
          </button>
          <button class="nav-button" onclick="scrollToSection('map-section')">
            Map
          </button>
          <button
            class="nav-button"
            onclick="scrollToSection('data-table-section')"
          >
            Full Data
          </button>
          <button class="nav-button" onclick="scrollToSection('about-section')">
            About
          </button>
          <button
            class="nav-button"
            onclick="scrollToSection('methodology-section')"
          >
            Methodology
          </button>
          <button
            class="nav-button"
            onclick="scrollToSection('investigations-section')"
          >
            Investigations
          </button>
        </div>
      </div>

      <div class="landing-section" id="recent-changes">
        <div class="header">
          <h1>Forest Reserve Tracker</h1>
          <p>
            Addition and removal of forest reserves in Peninsular Malaysia as
            published in government gazettes.
          </p>
          <p>From Jan 1, 2002 to <span id="update-date1"></span></p>
        </div>

        <div class="table-container">
          <div class="table-header">
            <div class="table-title-row">
              <span class="table-title-text">Changes in</span>
              <select class="filter-dropdown" id="state-dropdown">
                <option value="Peninsular Malaysia">Peninsular Malaysia</option>
                <option value="Johor">Johor</option>
                <option value="Kedah">Kedah</option>
                <option value="Kelantan">Kelantan</option>
                <option value="Kuala Lumpur">Kuala Lumpur</option>
                <option value="Melaka">Melaka</option>
                <option value="Negeri Sembilan">Negeri Sembilan</option>
                <option value="Pahang">Pahang</option>
                <option value="Perak">Perak</option>
                <option value="Perlis">Perlis</option>
                <option value="Selangor">Selangor</option>
                <option value="Terengganu">Terengganu</option>
              </select>
              <p>
                <span class="table-title-text">in the Last</span>
                <select class="filter-dropdown" id="period-dropdown">
                  <option value="60">2 months</option>
                  <option value="180">6 months</option>
                  <option value="365">12 months</option>
                </select>
              </p>
            </div>

            <div class="update-date-row">
              Updated: <span id="update-date2"></span>
              <button class="download-button" id="download-csv">
                Download Table Data
              </button>
            </div>
          </div>

          <div id="table-content">
            <div class="loading">Loading data...</div>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <section id="map-section" class="section">
        <h2>Interactive Map</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            Map visualization will be displayed here. This section will show the
            geographic distribution of forest reserve changes across Peninsular
            Malaysia.
          </p>
        </div>
      </section>

      <!-- Full Data Table Section -->
      <section id="data-table-section" class="section">
        <h2>Complete Data Table</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            A comprehensive table of all forest reserve changes will be
            displayed here, with advanced filtering and sorting options.
          </p>
        </div>
      </section>

      <!-- About Section -->
      <section id="about-section" class="section">
        <h2>About Forest Reserves</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            This section will contain an article explaining what forest reserves
            are, their importance, and the legal framework governing them in
            Malaysia.
          </p>
        </div>
      </section>

      <!-- Methodology Section -->
      <section id="methodology-section" class="section">
        <h2>Data Methodology</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            This section will explain how the data is collected, processed, and
            updated. It will detail the sources, validation processes, and any
            limitations.
          </p>
        </div>
      </section>

      <!-- Investigations Section -->
      <section id="investigations-section" class="section">
        <h2>What You Can Investigate</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            This section will provide guidance on how users can analyze the
            data, suggest research questions, and demonstrate potential
            investigations using the dataset.
          </p>
        </div>
      </section>
    </div>

    <!-- External JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
      const CSV_URL =
        "https://raw.githubusercontent.com/yhlreporter/frt/refs/heads/main/gazettes_20260120.csv";
      let lastUpdatedDate = null;
      let allData = [];
      let selectedState = "Peninsular Malaysia";
      let selectedPeriod = 60;
      let currentFilteredData = [];

      function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.scrollIntoView({ behavior: "smooth" });
          document
            .querySelectorAll(".nav-button")
            .forEach((btn) => btn.classList.remove("active"));
          event.target.classList.add("active");
        }
      }

      function updateScrollIndicators() {
        const nav = document.getElementById("nav-bar");
        const scrollLeft = nav.scrollLeft;
        const scrollWidth = nav.scrollWidth;
        const clientWidth = nav.clientWidth;

        if (scrollLeft > 10) {
          nav.classList.add("show-left-arrow");
        } else {
          nav.classList.remove("show-left-arrow");
        }

        if (scrollLeft < scrollWidth - clientWidth - 10) {
          nav.classList.add("show-right-arrow");
        } else {
          nav.classList.remove("show-right-arrow");
        }
      }

      document
        .getElementById("nav-bar")
        .addEventListener("scroll", updateScrollIndicators);
      window.addEventListener("load", updateScrollIndicators);
      window.addEventListener("resize", updateScrollIndicators);

      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          processData(results.data);
        },
        error: function (error) {
          document.getElementById("table-content").innerHTML =
            '<div class="no-data">Error loading data: ' +
            error.message +
            "</div>";
        },
      });

      function processData(data) {
        allData = data;
        const updateDateToChange = "2025,12,31";
        lastUpdatedDate = new Date(updateDateToChange);
        const updateDateEl1 = document.getElementById("update-date1");
        const updateDateEl2 = document.getElementById("update-date2");
        const formattedDate = lastUpdatedDate.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        updateDateEl1.textContent = formattedDate;
        updateDateEl2.textContent = formattedDate;

        document
          .getElementById("state-dropdown")
          .addEventListener("change", function () {
            selectedState = this.value;
            filterAndDisplayData();
          });

        document
          .getElementById("period-dropdown")
          .addEventListener("change", function () {
            selectedPeriod = parseInt(this.value);
            filterAndDisplayData();
          });

        document
          .getElementById("download-csv")
          .addEventListener("click", function () {
            downloadFilteredDataAsCSV();
          });

        filterAndDisplayData();
      }

      function filterAndDisplayData() {
        const startDate = new Date(lastUpdatedDate);
        startDate.setDate(lastUpdatedDate.getDate() - selectedPeriod);

        let filteredData = allData.filter((row) => {
          const gazetteDate = new Date(
            parseInt(row.gaz_year),
            parseInt(row.gaz_month) - 1,
            parseInt(row.gaz_day),
          );
          const withinPeriod =
            gazetteDate >= startDate && gazetteDate <= lastUpdatedDate;
          const stateMatches =
            selectedState === "Peninsular Malaysia" ||
            row.state === selectedState;
          return withinPeriod && stateMatches;
        });

        filteredData.sort((a, b) => {
          const dateA = new Date(
            parseInt(a.gaz_year),
            parseInt(a.gaz_month) - 1,
            parseInt(a.gaz_day),
          );
          const dateB = new Date(
            parseInt(b.gaz_year),
            parseInt(b.gaz_month) - 1,
            parseInt(b.gaz_day),
          );
          return dateB - dateA;
        });

        currentFilteredData = filteredData;
        displayTable(filteredData);
      }

      function downloadFilteredDataAsCSV() {
        if (currentFilteredData.length === 0) {
          alert("No data to download. Please adjust your filters.");
          return;
        }

        const headers = [
          "Gazette Date",
          "Forest Reserve",
          "Change",
          "Area (ha)",
          "State",
          "District",
          "Gazette Number",
        ];
        const rows = currentFilteredData.map((row) => {
          const gazetteDate = new Date(
            parseInt(row.gaz_year),
            parseInt(row.gaz_month) - 1,
            parseInt(row.gaz_day),
          );
          const year = gazetteDate.getFullYear();
          const month = String(gazetteDate.getMonth() + 1).padStart(2, "0");
          const day = String(gazetteDate.getDate()).padStart(2, "0");
          const dateStr = `${year}-${month}-${day}`;

          let change = "";
          let area = "";
          if (row.add && row.add.trim() !== "") {
            change = "Add";
            area = row.add;
          } else if (row.remove && row.remove.trim() !== "") {
            change = "Remove";
            area = row.remove;
          }

          return [
            `"${dateStr}"`,
            `"${(row.reserve || "-").replace(/"/g, '""')}"`,
            `"${change}"`,
            area,
            `"${(row.state || "-").replace(/"/g, '""')}"`,
            `"${(row.district || "-").replace(/"/g, '""')}"`,
            `"${(row.gaznum || "-").toString().replace(/"/g, '""')}"`,
          ].join(",");
        });

        const csvContent = [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const stateSlug = selectedState.toLowerCase().replace(/\s+/g, "-");
        const periodLabel =
          selectedPeriod === 60
            ? "2months"
            : selectedPeriod === 180
              ? "6months"
              : "12months";
        const filename = `forest-reserves-${stateSlug}-${periodLabel}.csv`;
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function displayTable(data) {
        const tableContent = document.getElementById("table-content");
        if (data.length === 0) {
          tableContent.innerHTML =
            '<div class="no-data">No forest reserve changes found for the selected filters</div>';
          return;
        }

        let html = `<table><thead><tr><th>Gazette Date</th><th>Forest Reserve</th><th>Change</th><th>Area (ha)</th><th>State and District</th><th>Gazette Number</th></tr></thead><tbody>`;

        data.forEach((row) => {
          const gazetteDate = new Date(
            parseInt(row.gaz_year),
            parseInt(row.gaz_month) - 1,
            parseInt(row.gaz_day),
          );
          const dateStr = gazetteDate.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });

          let change = "";
          let area = "";
          let changeClass = "";

          if (row.add && row.add.trim() !== "") {
            change = "Add";
            area = Math.round(parseFloat(row.add)).toLocaleString();
            changeClass = "change-add";
          } else if (row.remove && row.remove.trim() !== "") {
            change = "Remove";
            area = Math.round(parseFloat(row.remove)).toLocaleString();
            changeClass = "change-remove";
          }

          let gazetteNum = "-";
          if (
            row.gaznum !== undefined &&
            row.gaznum !== null &&
            row.gaznum !== ""
          ) {
            gazetteNum = String(row.gaznum);
          }

          let stateDistrict = row.state || "-";
          if (row.district && row.district.trim() !== "") {
            stateDistrict = `${row.state || "-"}, ${row.district}`;
          }

          html += `<tr><td>${dateStr}</td><td>${row.reserve || "-"}</td><td class="${changeClass}">${change}</td><td>${area}</td><td>${stateDistrict}</td><td>${gazetteNum}</td></tr>`;
        });

        html += `</tbody></table><div class="table-footer">Note: Area rounded off. Click <a href="${CSV_URL}" target="_blank">here</a> to download full data.</div>`;
        tableContent.innerHTML = html;
      }
    </script>
  </body>
</html>
