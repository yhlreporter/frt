<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Rufina:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <title>Forest Reserve Tracker</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --forest-dark: #1a3a0fff;
        --forest-medium: #2d6a4f;
        --forest-light: #52b788;
        --forest-pale: #d8f3dc;
        --text-dark: #080826ff;
        --text-light: #efece8ff;
        --border-radius: 6px;
        --transition-speed: 0.3s;
      }

      .bodi {
        font-family:
          "Nunito",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        color: var(--text-dark);
      }

      .navigation {
        position: sticky;
        height: 5vh;
        margin-bottom: -5vh;
        top: 0;
        z-index: 1000;
        background: var(--text-dark);
        width: 100%;
        box-shadow: 0 2px 6px var(--text-dark);
        overflow-x: auto;
        overflow-y: hidden;
        scrollbar-width: none;
        scrollbar-color: var(--forest-light) var(--text-dark);
      }

      .navigation::before,
      .navigation::after {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        width: 30px;
        pointer-events: none;
        z-index: 1001;
        display: none;
      }

      .navigation::before {
        left: 0;
        background: linear-gradient(
          to right,
          var(--text-dark) 0%,
          transparent 100%
        );
      }

      .navigation::after {
        right: 0;
        background: linear-gradient(
          to left,
          var(--text-dark) 0%,
          transparent 100%
        );
      }

      .navigation.show-left-arrow::before,
      .navigation.show-right-arrow::after {
        display: block;
      }

      .scroll-indicator {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        pointer-events: none;
        z-index: 1002;
        display: none;
      }

      .scroll-indicator svg {
        width: 100%;
        height: 100%;
        fill: var(--forest-light);
      }

      .scroll-indicator-left {
        left: 5px;
      }

      .scroll-indicator-right {
        right: 5px;
      }

      .navigation.show-left-arrow .scroll-indicator-left,
      .navigation.show-right-arrow .scroll-indicator-right {
        display: block;
      }

      .navigation::-webkit-scrollbar {
        height: 16px;
      }

      .navigation::-webkit-scrollbar-track {
        background: var(--text-dark);
      }

      .navigation::-webkit-scrollbar-thumb {
        background: var(--forest-light);
        border-radius: var(--border-radius);
      }

      .navigation::-webkit-scrollbar-thumb:hover {
        background: var(--forest-medium);
      }

      .nav-buttons {
        display: flex;
        height: 5vh;
        gap: 10px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        min-width: min-content;
        padding: 0 10px;
      }

      .nav-button {
        background: var(--forest-light);
        color: var(--text-dark);
        border: solid 2px;
        padding: 5px 10px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 400;
        transition: all var(--transition-speed) ease;
        font-family: inherit;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .nav-button:hover {
        background: var(--forest-medium);
        color: var(--text-light);
        border-color: var(--forest-pale);
      }

      .nav-button.active {
        background: var(--forest-light);
        color: var(--text-dark);
      }

      .landing-section {
        width: 100%;
        height: 100vh;
        padding: 60px 20px 30px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: var(--forest-pale);
        text-align: center;
        overflow: hidden;
      }

      .section {
        min-height: 100vh;
        padding: 80px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .section h2 {
        font-family: "Rufina", serif;
        font-size: 2.5rem;
        margin-bottom: 30px;
        color: var(--text-dark);
      }

      .section-content {
        max-width: 1400px;
        width: 100%;
      }

      #map-section {
        background: var(--forest-pale);
      }

      #data-table-section {
        background: #f1f8e9;
      }

      #about-section {
        background: #f9fbe7;
      }

      #methodology-section {
        background: #fffde7;
      }

      #investigations-section {
        background: #fff8e1;
      }

      .header {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 2vh;
        line-height: 1.2;
        flex-shrink: 0;
        max-width: 60vw;
      }

      .header h1 {
        font-family: "Rufina", serif;
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1vh;
      }

      .header p {
        font-size: 1.1rem;
        line-height: 1.5;
        margin: 0 auto;
      }

      .table-container {
        background: var(--text-dark);
        border-radius: var(--border-radius);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 3vh 1vw;
        width: 80%;
        gap: 2vh;
        margin: 1vh 0vw;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }

      .table-header {
        display: flex;
        flex-direction: column;
        gap: 1vh;
        flex-shrink: 0;
        align-items: center;
      }

      .table-title-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        color: var(--text-light);
        line-height: 1.6;
      }

      .table-title-text {
        font-weight: 400;
      }

      .filter-dropdown {
        background: var(--forest-light);
        color: var(--text-light);
        border: 2px solid var(--forest-light);
        padding: 0px 8px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        transition: all var(--transition-speed) ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23080826' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 32px;
      }

      .filter-dropdown:hover {
        background: var(--forest-medium);
        color: var(--text-light);
        border-color: var(--forest-pale);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'  viewBox='0 0 12 12'%3E%3Cpath fill='%23efece8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
      }

      .update-date-row {
        color: var(--text-light);
        font-size: 1rem;
      }

      .download-button {
        background: var(--forest-light);
        color: var(--text-dark);
        padding: 4px 8px;
        border: solid 2px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all var(--transition-speed) ease;
        font-family: inherit;
        align-self: flex-start;
      }

      .download-button:hover {
        background: var(--forest-medium);
        color: var(--text-light);
        border-color: var(--forest-pale);
      }

      #table-content {
        overflow-x: auto;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
      }

      #table-content::-webkit-scrollbar {
        width: 6px;
      }

      #table-content::-webkit-scrollbar-track {
        background: var(--text-dark);
        border-radius: var(--border-radius);
      }

      #table-content::-webkit-scrollbar-thumb {
        background: var(--forest-pale);
        border-radius: var(--border-radius);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.1rem;
      }

      table {
        width: 100%;
        scrollbar-color: var(--forest-light);
        scrollbar-width: 2px;
        border-collapse: collapse;
      }

      thead {
        background-color: var(--forest-medium);
        color: var(--text-light);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      th,
      td {
        padding: 12px 8px;
        text-align: center;
        border-bottom: 1px solid #dddddd2b;
        color: var(--text-light);
      }

      th {
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: capitalize;
      }

      .change-add {
        color: #3c8aff;
        font-weight: 600;
      }

      .change-remove {
        color: #e74c3c;
        font-weight: 600;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
        font-style: italic;
      }

      .table-footer {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #dddddd2b;
        text-align: center;
        color: var(--text-light);
        font-size: 0.9rem;
      }

      .table-footer a {
        color: var(--forest-light);
        text-decoration: none;
        font-weight: 600;
      }

      .table-footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .landing-section {
          padding: 60px 10px 30px 10px;
        }

        .table-container {
          padding: 2vh 1vw;
          width: 100%;
          margin-top: 15px;
          margin-bottom: 20px;
        }

        .header {
          max-width: 100vw;
          margin-bottom: 2vh;
        }

        .header h1 {
          font-size: 2rem;
          margin-bottom: 1vh;
        }

        .header p {
          max-width: 80vw;
          font-size: 0.9rem;
          line-height: 1.2rem;
        }

        .navigation {
          -webkit-overflow-scrolling: touch;
        }

        .nav-buttons {
          justify-content: flex-start;
          flex-wrap: nowrap;
          padding: 0 10px;
        }

        .nav-button {
          font-size: 0.9rem;
          padding: 6px 10px;
        }

        .table-title-row {
          font-size: 1rem;
          justify-content: center;
          text-align: center;
        }

        .filter-dropdown {
          font-size: 0.9rem;
          padding: 2px 8px;
          padding-right: 28px;
        }

        table {
          font-size: 0.75rem;
        }

        th,
        td {
          padding: 8px 4px;
          font-size: 0.75rem;
        }

        th:nth-child(1),
        td:nth-child(1) {
          min-width: 70px;
        }

        th:nth-child(2),
        td:nth-child(2) {
          min-width: 100px;
          max-width: 140px;
          word-wrap: break-word;
        }

        th:nth-child(3),
        td:nth-child(3) {
          min-width: 50px;
        }

        th:nth-child(4),
        td:nth-child(4) {
          min-width: 60px;
        }

        th:nth-child(5),
        td:nth-child(5) {
          min-width: 80px;
          max-width: 140px;
          word-wrap: break-word;
        }

        th:nth-child(6),
        td:nth-child(6) {
          min-width: 50px;
        }
      }

      /* Map Section Styles */
      .map-container-wrapper {
        display: flex;
        width: 100%;
        height: 80vh;
        gap: 20px;
        flex-wrap: wrap;
      }

      .map-view {
        flex: 0 0 60%;
        height: 100%;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .map-data-panel {
        flex: 0 0 calc(40% - 20px);
        height: 100%;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .panel-header {
        padding: 20px;
        background: var(--forest-dark);
        color: var(--text-light);
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .panel-header h3 {
        margin: 0;
        font-family: "Rufina", serif;
        font-size: 1.5rem;
      }

      .reset-map-button {
        background: var(--forest-light);
        color: var(--text-dark);
        border: none;
        padding: 8px 12px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all var(--transition-speed) ease;
        font-family: inherit;
      }

      .reset-map-button:hover {
        background: var(--forest-pale);
      }

      .panel-content {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
      }

      .stat-card {
        background: var(--forest-pale);
        padding: 20px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        text-align: center;
      }

      .stat-card h4 {
        margin: 0 0 10px 0;
        font-size: 1rem;
        color: var(--text-dark);
        font-weight: 600;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 10px 0;
        color: var(--forest-dark);
      }

      .stat-value.positive {
        color: var(--forest-light);
      }

      .stat-value.negative {
        color: #e74c3c;
      }

      .stat-label {
        font-size: 0.85rem;
        color: #666;
        margin: 5px 0 0 0;
      }

      .chart-card {
        background: var(--text-dark);
        padding: 20px;
        border-radius: var(--border-radius);
        border: none;
        margin-bottom: 20px;
      }

      .chart-card h4 {
        margin: 0 0 15px 0;
        font-size: 1rem;
        color: var(--text-light);
        font-weight: 600;
      }

      .table-card {
        background: var(--text-dark);
        padding: 20px;
        border-radius: var(--border-radius);
        border: none;
        margin-bottom: 20px;
      }

      .table-card h4 {
        margin: 0 0 15px 0;
        font-size: 1rem;
        color: var(--text-light);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .expand-toggle {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        color: var(--forest-light);
        transition: transform var(--transition-speed) ease;
      }

      .expand-toggle.expanded {
        transform: rotate(180deg);
      }

      .table-content-expandable {
        max-height: 0;
        overflow: hidden;
        transition: max-height var(--transition-speed) ease;
      }

      .table-content-expandable.expanded {
        max-height: 600px;
        overflow-y: auto;
      }

      .table-content-small {
        overflow-x: auto;
      }

      .table-card table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }

      .table-card thead {
        background-color: var(--forest-medium);
        color: var(--text-light);
        position: sticky;
        top: 0;
      }

      .table-card th {
        padding: 8px 6px;
        text-align: left;
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--text-light);
      }

      .table-card td {
        padding: 8px 6px;
        border-bottom: 1px solid #dddddd2b;
        color: var(--text-light);
        text-align: left;
      }

      .table-card tr:hover {
        background-color: rgba(82, 183, 136, 0.1);
      }

      /* Leaflet popup customization */
      .leaflet-popup-content-wrapper {
        border-radius: var(--border-radius);
        font-family: "Nunito", sans-serif;
      }

      .leaflet-popup-content {
        margin: 10px 15px;
      }

      /* Mobile responsiveness for map section */
      @media (max-width: 768px) {
        .map-container-wrapper {
          flex-direction: column;
          height: auto;
        }

        .map-view {
          flex: 0 0 100%;
          height: 50vh;
        }

        .map-data-panel {
          flex: 0 0 100%;
          height: auto;
          min-height: 60vh;
        }

        .panel-header {
          flex-direction: column;
          gap: 10px;
          align-items: flex-start;
        }

        .panel-header h3 {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="bodi">
      <!-- Navigation Bar -->
      <div class="navigation" id="nav-bar">
        <div class="scroll-indicator scroll-indicator-left">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
          </svg>
        </div>
        <div class="scroll-indicator scroll-indicator-right">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
          </svg>
        </div>
        <div class="nav-buttons">
          <button
            class="nav-button"
            onclick="scrollToSection('recent-changes')"
          >
            Recent Changes
          </button>
          <button class="nav-button" onclick="scrollToSection('map-section')">
            Map
          </button>
          <button
            class="nav-button"
            onclick="scrollToSection('data-table-section')"
          >
            Full Data
          </button>
          <button class="nav-button" onclick="scrollToSection('about-section')">
            About
          </button>
          <button
            class="nav-button"
            onclick="scrollToSection('methodology-section')"
          >
            Methodology
          </button>
          <button
            class="nav-button"
            onclick="scrollToSection('investigations-section')"
          >
            Investigations
          </button>
        </div>
      </div>

      <div class="landing-section" id="recent-changes">
        <div class="header">
          <h1>Forest Reserve Tracker</h1>
          <p>
            Addition and removal of forest reserves in Peninsular Malaysia as
            published in government gazettes.
          </p>
          <p>From Jan 1, 2002 to <span id="update-date1"></span></p>
        </div>

        <div class="table-container">
          <div class="table-header">
            <div class="table-title-row">
              <span class="table-title-text">Changes in</span>
              <select class="filter-dropdown" id="state-dropdown">
                <option value="Peninsular Malaysia">Peninsular Malaysia</option>
                <option value="Johor">Johor</option>
                <option value="Kedah">Kedah</option>
                <option value="Kelantan">Kelantan</option>
                <option value="Kuala Lumpur">Kuala Lumpur</option>
                <option value="Melaka">Melaka</option>
                <option value="Negeri Sembilan">Negeri Sembilan</option>
                <option value="Pahang">Pahang</option>
                <option value="Perak">Perak</option>
                <option value="Perlis">Perlis</option>
                <option value="Selangor">Selangor</option>
                <option value="Terengganu">Terengganu</option>
              </select>
              <p>
                <span class="table-title-text">in the Last</span>
                <select class="filter-dropdown" id="period-dropdown">
                  <option value="60">2 months</option>
                  <option value="180">6 months</option>
                  <option value="365">12 months</option>
                </select>
              </p>
            </div>

            <div class="update-date-row">
              Updated: <span id="update-date2"></span>
              <button class="download-button" id="download-csv">
                Download Table Data
              </button>
            </div>
          </div>

          <div id="table-content">
            <div class="loading">Loading data...</div>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <section id="map-section" class="section">
        <h2>Interactive Map</h2>
        <div class="map-container-wrapper">
          <!-- Left: Map (60%) -->
          <div id="map" class="map-view"></div>

          <!-- Right: Data Panel (40%) -->
          <div class="map-data-panel">
            <div class="panel-header">
              <h3 id="panel-state-title">Peninsular Malaysia</h3>
              <button
                class="reset-map-button"
                id="reset-map"
                style="display: none"
              >
                Reset to Peninsular Malaysia
              </button>
            </div>

            <div class="panel-content">
              <!-- Net Change Summary -->
              <div class="stat-card">
                <h4>Total Net Change</h4>
                <p class="stat-value" id="net-change-value">Loading...</p>
                <p class="stat-label">
                  From Jan 1, 2002 to <span id="map-update-date"></span>
                </p>
              </div>

              <!-- Yearly Net Change Chart -->
              <div class="chart-card">
                <h4>Net Yearly Change</h4>
                <canvas id="yearly-chart"></canvas>
              </div>

              <!-- Recent Changes Table -->
              <div class="table-card">
                <h4>
                  10 Most Recent Changes
                  <button class="expand-toggle" id="toggle-recent">â–¼</button>
                </h4>
                <div class="table-content-expandable" id="recent-changes-table">
                  Loading...
                </div>
              </div>

              <!-- Top 5 Additions -->
              <div class="table-card">
                <h4>Top 5 Additions by Area</h4>
                <div class="table-content-small" id="top-additions-table">
                  Loading...
                </div>
              </div>

              <!-- Top 5 Removals -->
              <div class="table-card">
                <h4>Top 5 Removals by Area</h4>
                <div class="table-content-small" id="top-removals-table">
                  Loading...
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Full Data Table Section -->
      <section id="data-table-section" class="section">
        <h2>Complete Data Table</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            A comprehensive table of all forest reserve changes will be
            displayed here, with advanced filtering and sorting options.
          </p>
        </div>
      </section>

      <!-- About Section -->
      <section id="about-section" class="section">
        <h2>About Forest Reserves</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            This section will contain an article explaining what forest reserves
            are, their importance, and the legal framework governing them in
            Malaysia.
          </p>
        </div>
      </section>

      <!-- Methodology Section -->
      <section id="methodology-section" class="section">
        <h2>Data Methodology</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            This section will explain how the data is collected, processed, and
            updated. It will detail the sources, validation processes, and any
            limitations.
          </p>
        </div>
      </section>

      <!-- Investigations Section -->
      <section id="investigations-section" class="section">
        <h2>What You Can Investigate</h2>
        <div class="section-content">
          <p style="text-align: center; color: #666; font-size: 1.2rem">
            This section will provide guidance on how users can analyze the
            data, suggest research questions, and demonstrate potential
            investigations using the dataset.
          </p>
        </div>
      </section>
    </div>

    <!-- External JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
      // Configuration Constants
      const CONFIG = {
        CSV_URL:
          "https://raw.githubusercontent.com/yhlreporter/frt/refs/heads/main/gazettes_20260120.csv",
        GEOJSON_URL:
          "https://raw.githubusercontent.com/yhlreporter/frt/refs/heads/main/states.geojson",
        MAPBOX_STYLE_URL:
          "https://api.mapbox.com/styles/v1/yhlreporter/cmkn2sb5b00a701qm8uo8aiol/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoieWhscmVwb3J0ZXIiLCJhIjoiY21rbjJmdnY3MGIxZjNkb3A4cjE1MmNhMyJ9.kHTzPHj00zMVnCZwhBOcdg",

        MAP_CENTER: [4.2105, 101.9758], // Peninsular Malaysia center
        MAP_ZOOM: 6.5,
        SCROLL_THRESHOLD: 10,
        DATE_FORMAT_OPTIONS: {
          year: "numeric",
          month: "long",
          day: "numeric",
        },
        DATE_FORMAT_SHORT: {
          year: "numeric",
          month: "short",
          day: "numeric",
        },
        STATES: [
          "Johor",
          "Kedah",
          "Kelantan",
          "Kuala Lumpur",
          "Melaka",
          "Negeri Sembilan",
          "Pahang",
          "Perak",
          "Perlis",
          "Selangor",
          "Terengganu",
        ],
        REQUIRED_FIELDS: [
          "gaz_year",
          "gaz_month",
          "gaz_day",
          "state",
          "reserve",
        ],
      };

      // Centralized state management
      const appState = {
        lastUpdatedDate: null,
        allData: [],
        validData: [],
        selectedState: "Peninsular Malaysia",
        selectedPeriod: 60,
        currentFilteredData: [],
        map: null,
        geojsonLayer: null,
        currentChart: null,
        mapSelectedState: "Peninsular Malaysia",
        selectedLayer: null,
      };

      // Helper function: Create debounced function
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Data Validation Functions
      function validateRowData(row) {
        // Check if all required fields exist and have values
        for (const field of CONFIG.REQUIRED_FIELDS) {
          if (!row[field] || row[field].trim() === "") {
            return false;
          }
        }

        // Validate state is in the approved list
        if (!CONFIG.STATES.includes(row.state)) {
          return false;
        }

        // Validate date components are valid numbers
        const year = parseInt(row.gaz_year);
        const month = parseInt(row.gaz_month);
        const day = parseInt(row.gaz_day);

        if (
          isNaN(year) ||
          isNaN(month) ||
          isNaN(day) ||
          year < 2000 ||
          year > 2100 ||
          month < 1 ||
          month > 12 ||
          day < 1 ||
          day > 31
        ) {
          return false;
        }

        // Must have either add or remove value
        const hasAdd = row.add && row.add.trim() !== "";
        const hasRemove = row.remove && row.remove.trim() !== "";
        if (!hasAdd && !hasRemove) {
          return false;
        }

        return true;
      }

      function validateAndFilterData(data) {
        const validRows = [];
        const invalidRows = [];

        data.forEach((row, index) => {
          if (validateRowData(row)) {
            validRows.push(row);
          } else {
            invalidRows.push({ index, row });
          }
        });

        // Log validation summary
        if (invalidRows.length > 0) {
          console.warn(
            `Data validation: ${invalidRows.length} invalid rows filtered out of ${data.length} total rows`,
          );
          console.log("Invalid rows:", invalidRows);
        } else {
          console.log(`Data validation: All ${data.length} rows are valid`);
        }

        return validRows;
      }

      // Helper function: Format gazette date from row data
      function formatGazetteDate(row) {
        try {
          const year = parseInt(row.gaz_year);
          const month = parseInt(row.gaz_month) - 1;
          const day = parseInt(row.gaz_day);

          const date = new Date(year, month, day);

          // Check if date is valid
          if (isNaN(date.getTime())) {
            console.error("Invalid date for row:", row);
            return null;
          }

          return date;
        } catch (error) {
          console.error("Error formatting date for row:", row, error);
          return null;
        }
      }

      // Helper function: Extract change information from row
      function getChangeInfo(row) {
        if (row.add && row.add.trim() !== "") {
          return { type: "Add", area: row.add, cssClass: "change-add" };
        } else if (row.remove && row.remove.trim() !== "") {
          return {
            type: "Remove",
            area: row.remove,
            cssClass: "change-remove",
          };
        }
        return { type: "", area: "", cssClass: "" };
      }

      // Map Data Analysis Functions
      function analyzeDataForState(stateName) {
        // Filter data by state
        const stateData =
          stateName === "Peninsular Malaysia"
            ? appState.allData
            : appState.allData.filter((row) => row.state === stateName);

        // Calculate total net change
        let totalAdded = 0;
        let totalRemoved = 0;

        stateData.forEach((row) => {
          const changeInfo = getChangeInfo(row);
          const area = parseFloat(changeInfo.area) || 0;

          if (changeInfo.type === "Add") {
            totalAdded += area;
          } else if (changeInfo.type === "Remove") {
            totalRemoved += area;
          }
        });

        const netChange = totalAdded - totalRemoved;

        // Calculate yearly statistics
        const yearlyData = {};
        stateData.forEach((row) => {
          const year = parseInt(row.gaz_year);
          const changeInfo = getChangeInfo(row);
          const area = parseFloat(changeInfo.area) || 0;

          if (!yearlyData[year]) {
            yearlyData[year] = { added: 0, removed: 0 };
          }

          if (changeInfo.type === "Add") {
            yearlyData[year].added += area;
          } else if (changeInfo.type === "Remove") {
            yearlyData[year].removed += area;
          }
        });

        // Convert to sorted array
        const yearlyStats = Object.keys(yearlyData)
          .sort()
          .map((year) => ({
            year: parseInt(year),
            added: yearlyData[year].added,
            removed: yearlyData[year].removed,
            net: yearlyData[year].added - yearlyData[year].removed,
          }));

        // Get recent changes (sorted by date, newest first)
        const recentChanges = [...stateData]
          .sort((a, b) => {
            const dateA = formatGazetteDate(a);
            const dateB = formatGazetteDate(b);
            if (!dateA || !dateB) return 0;
            return dateB - dateA;
          })
          .slice(0, 10);

        // Get top additions
        const additions = stateData
          .filter((row) => {
            const changeInfo = getChangeInfo(row);
            return changeInfo.type === "Add";
          })
          .sort((a, b) => {
            const areaA = parseFloat(getChangeInfo(a).area) || 0;
            const areaB = parseFloat(getChangeInfo(b).area) || 0;
            return areaB - areaA;
          })
          .slice(0, 5);

        // Get top removals
        const removals = stateData
          .filter((row) => {
            const changeInfo = getChangeInfo(row);
            return changeInfo.type === "Remove";
          })
          .sort((a, b) => {
            const areaA = parseFloat(getChangeInfo(a).area) || 0;
            const areaB = parseFloat(getChangeInfo(b).area) || 0;
            return areaB - areaA;
          })
          .slice(0, 5);

        return {
          totalAdded,
          totalRemoved,
          netChange,
          yearlyStats,
          recentChanges,
          topAdditions: additions,
          topRemovals: removals,
        };
      }

      function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.scrollIntoView({ behavior: "smooth" });
          document
            .querySelectorAll(".nav-button")
            .forEach((btn) => btn.classList.remove("active"));
          event.target.classList.add("active");
        }
      }

      function updateScrollIndicators() {
        const nav = document.getElementById("nav-bar");
        const scrollLeft = nav.scrollLeft;
        const scrollWidth = nav.scrollWidth;
        const clientWidth = nav.clientWidth;

        if (scrollLeft > CONFIG.SCROLL_THRESHOLD) {
          nav.classList.add("show-left-arrow");
        } else {
          nav.classList.remove("show-left-arrow");
        }

        if (scrollLeft < scrollWidth - clientWidth - CONFIG.SCROLL_THRESHOLD) {
          nav.classList.add("show-right-arrow");
        } else {
          nav.classList.remove("show-right-arrow");
        }
      }

      // Set up event listeners once on page load
      const debouncedScrollHandler = debounce(updateScrollIndicators, 100);

      document
        .getElementById("nav-bar")
        .addEventListener("scroll", debouncedScrollHandler);
      window.addEventListener("load", updateScrollIndicators);
      window.addEventListener("resize", updateScrollIndicators);

      // Set up dropdown event listeners once
      document
        .getElementById("state-dropdown")
        .addEventListener("change", function () {
          appState.selectedState = this.value;
          filterAndDisplayData();
        });

      document
        .getElementById("period-dropdown")
        .addEventListener("change", function () {
          appState.selectedPeriod = parseInt(this.value);
          filterAndDisplayData();
        });

      document
        .getElementById("download-csv")
        .addEventListener("click", function () {
          downloadFilteredDataAsCSV();
        });

      // Load and parse CSV data
      Papa.parse(CONFIG.CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          processData(results.data);
        },
        error: function (error) {
          document.getElementById("table-content").innerHTML =
            '<div class="no-data">Error loading data: ' +
            error.message +
            "</div>";
          console.error("CSV parsing error:", error);
        },
      });

      // Data Processing: Separate concerns into focused functions
      function processData(rawData) {
        // Validate and filter data
        appState.validData = validateAndFilterData(rawData);
        appState.allData = appState.validData;

        // Set the update date
        setUpdateDate();

        // Update UI with the date
        updateDateDisplays();

        // Filter and display the data
        filterAndDisplayData();
      }

      function setUpdateDate() {
        // Note: Currently using hardcoded date - will be replaced with dynamic calculation
        const updateDateToChange = "2025,12,31";
        appState.lastUpdatedDate = new Date(updateDateToChange);
      }

      function updateDateDisplays() {
        const updateDateEl1 = document.getElementById("update-date1");
        const updateDateEl2 = document.getElementById("update-date2");
        const formattedDate = appState.lastUpdatedDate.toLocaleDateString(
          "en-US",
          CONFIG.DATE_FORMAT_OPTIONS,
        );
        updateDateEl1.textContent = formattedDate;
        updateDateEl2.textContent = formattedDate;
      }

      function filterAndDisplayData() {
        const startDate = new Date(appState.lastUpdatedDate);
        startDate.setDate(
          appState.lastUpdatedDate.getDate() - appState.selectedPeriod,
        );

        let filteredData = appState.allData.filter((row) => {
          const gazetteDate = formatGazetteDate(row);

          // Skip rows with invalid dates
          if (!gazetteDate) {
            return false;
          }

          const withinPeriod =
            gazetteDate >= startDate && gazetteDate <= appState.lastUpdatedDate;
          const stateMatches =
            appState.selectedState === "Peninsular Malaysia" ||
            row.state === appState.selectedState;
          return withinPeriod && stateMatches;
        });

        // Sort by date (newest first)
        filteredData.sort((a, b) => {
          const dateA = formatGazetteDate(a);
          const dateB = formatGazetteDate(b);

          // Handle null dates gracefully
          if (!dateA && !dateB) return 0;
          if (!dateA) return 1;
          if (!dateB) return -1;

          return dateB - dateA;
        });

        appState.currentFilteredData = filteredData;
        displayTable(filteredData);
      }

      function downloadFilteredDataAsCSV() {
        if (appState.currentFilteredData.length === 0) {
          alert("No data to download. Please adjust your filters.");
          return;
        }

        const headers = [
          "Gazette Date",
          "Forest Reserve",
          "Change",
          "Area (ha)",
          "State",
          "District",
          "Gazette Number",
        ];

        const rows = appState.currentFilteredData
          .map((row) => {
            const gazetteDate = formatGazetteDate(row);

            // Skip rows with invalid dates
            if (!gazetteDate) {
              console.warn(
                "Skipping row with invalid date in CSV export:",
                row,
              );
              return null;
            }

            const year = gazetteDate.getFullYear();
            const month = String(gazetteDate.getMonth() + 1).padStart(2, "0");
            const day = String(gazetteDate.getDate()).padStart(2, "0");
            const dateStr = `${year}-${month}-${day}`;

            const changeInfo = getChangeInfo(row);

            return [
              `"${dateStr}"`,
              `"${(row.reserve || "-").replace(/"/g, '""')}"`,
              `"${changeInfo.type}"`,
              changeInfo.area,
              `"${(row.state || "-").replace(/"/g, '""')}"`,
              `"${(row.district || "-").replace(/"/g, '""')}"`,
              `"${(row.gaznum || "-").toString().replace(/"/g, '""')}"`,
            ].join(",");
          })
          .filter((row) => row !== null); // Remove any null rows from invalid dates

        const csvContent = [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const stateSlug = appState.selectedState
          .toLowerCase()
          .replace(/\s+/g, "-");
        const periodLabel =
          appState.selectedPeriod === 60
            ? "2months"
            : appState.selectedPeriod === 180
              ? "6months"
              : "12months";
        const filename = `forest-reserves-${stateSlug}-${periodLabel}.csv`;
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function displayTable(data) {
        const tableContent = document.getElementById("table-content");
        if (data.length === 0) {
          tableContent.innerHTML =
            '<div class="no-data">No forest reserve changes found for the selected filters</div>';
          return;
        }

        let html = `<table><thead><tr><th>Gazette Date</th><th>Forest Reserve</th><th>Change</th><th>Area (ha)</th><th>State and District</th><th>Gazette Number</th></tr></thead><tbody>`;

        data.forEach((row) => {
          const gazetteDate = formatGazetteDate(row);

          // Skip row if date formatting failed
          if (!gazetteDate) {
            console.warn("Skipping row with invalid date:", row);
            return;
          }

          const dateStr = gazetteDate.toLocaleDateString(
            "en-US",
            CONFIG.DATE_FORMAT_SHORT,
          );

          const changeInfo = getChangeInfo(row);
          const areaFormatted = changeInfo.area
            ? Math.round(parseFloat(changeInfo.area)).toLocaleString()
            : "";

          let gazetteNum = "-";
          if (
            row.gaznum !== undefined &&
            row.gaznum !== null &&
            row.gaznum !== ""
          ) {
            gazetteNum = String(row.gaznum);
          }

          let stateDistrict = row.state || "-";
          if (row.district && row.district.trim() !== "") {
            stateDistrict = `${row.state || "-"}, ${row.district}`;
          }

          html += `<tr><td>${dateStr}</td><td>${row.reserve || "-"}</td><td class="${changeInfo.cssClass}">${changeInfo.type}</td><td>${areaFormatted}</td><td>${stateDistrict}</td><td>${gazetteNum}</td></tr>`;
        });

        html += `</tbody></table><div class="table-footer">Note: Area rounded off. Click <a href="${CONFIG.CSV_URL}" target="_blank">here</a> to download full data.</div>`;
        tableContent.innerHTML = html;
      }

      // Map Initialization and Visualization Functions
      function initializeMap() {
        // Initialize Leaflet map
        appState.map = L.map("map").setView(CONFIG.MAP_CENTER, CONFIG.MAP_ZOOM);

        // Add Mapbox basemap
        L.tileLayer(CONFIG.MAPBOX_STYLE_URL, {
          attribution:
            '&copy; <a href="https://www.mapbox.com/">Mapbox</a> &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
          maxZoom: 18,
          tileSize: 256,
        }).addTo(appState.map);

        // Load GeoJSON overlay
        loadGeoJSON();

        // Set up reset button
        document
          .getElementById("reset-map")
          .addEventListener("click", function () {
            resetMapView();
          });

        // Set up expandable table toggle
        document
          .getElementById("toggle-recent")
          .addEventListener("click", function () {
            const table = document.getElementById("recent-changes-table");
            const button = document.getElementById("toggle-recent");
            table.classList.toggle("expanded");
            button.classList.toggle("expanded");
          });

        // Update map panel with initial data
        updateMapPanel("Peninsular Malaysia");
      }

      function loadGeoJSON() {
        fetch(CONFIG.GEOJSON_URL)
          .then((response) => response.json())
          .then((geojsonData) => {
            appState.geojsonLayer = L.geoJSON(geojsonData, {
              style: {
                fillColor: "#52b788",
                weight: 2,
                opacity: 1,
                color: "#1a3a0f",
                fillOpacity: 0,
              },
              onEachFeature: function (feature, layer) {
                const stateName =
                  feature.properties.name || feature.properties.state;

                // Hover effect
                layer.on("mouseover", function () {
                  // Only apply hover if this isn't the selected layer
                  if (appState.selectedLayer !== layer) {
                    layer.setStyle({
                      fillOpacity: 0.6,
                      weight: 3,
                    });
                  }
                });

                layer.on("mouseout", function () {
                  // Only reset if this isn't the selected layer
                  if (appState.selectedLayer !== layer) {
                    layer.setStyle({
                      fillOpacity: 0,
                      weight: 2,
                    });
                  }
                });

                // Click handler
                layer.on("click", function () {
                  onStateClick(stateName, layer);
                });

                // Bind popup
                layer.bindPopup(
                  `<strong>${stateName}</strong><br>Click to view details`,
                );
              },
            }).addTo(appState.map);
          })
          .catch((error) => {
            console.error("Error loading GeoJSON:", error);
          });
      }

      function onStateClick(stateName, layer) {
        appState.mapSelectedState = stateName;

        // Reset previous selected layer style
        if (appState.selectedLayer) {
          appState.selectedLayer.setStyle({
            fillOpacity: 0.3,
            weight: 2,
            color: "#1a3a0f",
          });
        }

        // Highlight the selected layer
        layer.setStyle({
          fillOpacity: 0.5,
          weight: 3,
          color: "#2d6a4f",
        });
        appState.selectedLayer = layer;

        // Ensure map size is correct (important after style changes)
        appState.map.invalidateSize();

        // Small delay to ensure layer styling is complete before fitting bounds
        setTimeout(() => {
          // Get the bounds of the clicked state polygon
          const bounds = layer.getBounds();

          // Fit bounds with generous padding to ensure entire state is visible
          appState.map.fitBounds(bounds, {
            padding: [50, 50], // Generous padding for visibility
            animate: true,
            duration: 1,
          });
        }, 50);

        // Update panel
        updateMapPanel(stateName);

        // Show reset button
        document.getElementById("reset-map").style.display = "block";
      }

      function resetMapView() {
        appState.mapSelectedState = "Peninsular Malaysia";

        // Reset selected layer style
        if (appState.selectedLayer) {
          appState.selectedLayer.setStyle({
            fillOpacity: 0.3,
            weight: 2,
            color: "#1a3a0f",
          });
          appState.selectedLayer = null;
        }

        // Smoothly fly back to the original view
        appState.map.flyTo(CONFIG.MAP_CENTER, CONFIG.MAP_ZOOM, {
          animate: true,
          duration: 0.8,
        });

        updateMapPanel("Peninsular Malaysia");
        document.getElementById("reset-map").style.display = "none";
      }

      function updateMapPanel(stateName) {
        // Update title
        document.getElementById("panel-state-title").textContent = stateName;

        // Update date
        document.getElementById("map-update-date").textContent =
          appState.lastUpdatedDate.toLocaleDateString(
            "en-US",
            CONFIG.DATE_FORMAT_OPTIONS,
          );

        // Analyze data for selected state
        const analysis = analyzeDataForState(stateName);

        // Update net change
        const netChangeEl = document.getElementById("net-change-value");
        const netChangeFormatted = Math.round(
          analysis.netChange,
        ).toLocaleString();
        netChangeEl.textContent = `${analysis.netChange >= 0 ? "+" : ""}${netChangeFormatted} ha`;
        netChangeEl.className = "stat-value";
        if (analysis.netChange > 0) {
          netChangeEl.classList.add("positive");
        } else if (analysis.netChange < 0) {
          netChangeEl.classList.add("negative");
        }

        // Update chart
        updateYearlyChart(analysis.yearlyStats);

        // Update tables
        updateRecentChangesTable(analysis.recentChanges);
        updateTopTable("top-additions-table", analysis.topAdditions);
        updateTopTable("top-removals-table", analysis.topRemovals);
      }

      function updateYearlyChart(yearlyStats) {
        const ctx = document.getElementById("yearly-chart").getContext("2d");

        // Destroy existing chart if it exists
        if (appState.currentChart) {
          appState.currentChart.destroy();
        }

        // Create new chart
        appState.currentChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: yearlyStats.map((stat) => stat.year),
            datasets: [
              {
                label: "Net Change (ha)",
                data: yearlyStats.map((stat) => Math.round(stat.net)),
                backgroundColor: yearlyStats.map((stat) =>
                  stat.net >= 0 ? "#52b788" : "#e74c3c",
                ),
                borderColor: yearlyStats.map((stat) =>
                  stat.net >= 0 ? "#2d6a4f" : "#c0392b",
                ),
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString() + " ha";
                  },
                },
              },
            },
          },
        });
      }

      function updateRecentChangesTable(recentChanges) {
        const container = document.getElementById("recent-changes-table");

        if (recentChanges.length === 0) {
          container.innerHTML =
            '<p style="padding: 10px; color: #aaa;">No data available</p>';
          return;
        }

        let html = `<table><thead><tr><th>Date</th><th>Reserve</th><th>Type</th><th>Area (ha)</th></tr></thead><tbody>`;

        recentChanges.forEach((row) => {
          const gazetteDate = formatGazetteDate(row);
          if (!gazetteDate) return;

          const dateStr = gazetteDate.toLocaleDateString(
            "en-US",
            CONFIG.DATE_FORMAT_SHORT,
          );
          const changeInfo = getChangeInfo(row);
          const areaFormatted = changeInfo.area
            ? Math.round(parseFloat(changeInfo.area)).toLocaleString()
            : "";

          html += `<tr><td>${dateStr}</td><td>${row.reserve || "-"}</td><td class="${changeInfo.cssClass}">${changeInfo.type}</td><td>${areaFormatted}</td></tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
      }

      function updateTopTable(elementId, data) {
        const container = document.getElementById(elementId);

        if (data.length === 0) {
          container.innerHTML =
            '<p style="padding: 10px; color: #aaa;">No data available</p>';
          return;
        }

        let html = `<table><thead><tr><th>Reserve</th><th>Area (ha)</th><th>Date</th></tr></thead><tbody>`;

        data.forEach((row) => {
          const gazetteDate = formatGazetteDate(row);
          if (!gazetteDate) return;

          const dateStr = gazetteDate.toLocaleDateString(
            "en-US",
            CONFIG.DATE_FORMAT_SHORT,
          );
          const changeInfo = getChangeInfo(row);
          const areaFormatted = changeInfo.area
            ? Math.round(parseFloat(changeInfo.area)).toLocaleString()
            : "";

          html += `<tr><td>${row.reserve || "-"}</td><td>${areaFormatted}</td><td>${dateStr}</td></tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
      }

      // Initialize map when data is loaded
      window.addEventListener("load", function () {
        // Wait for data to be loaded before initializing map
        const checkDataLoaded = setInterval(function () {
          if (appState.allData.length > 0) {
            clearInterval(checkDataLoaded);
            initializeMap();
          }
        }, 100);
      });
    </script>
  </body>
</html>
